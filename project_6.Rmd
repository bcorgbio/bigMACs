---
title: "Project6"
author: "bigMACs"
date: "2022-11-06"
output: html_document
bibliogprahy: Bib_6.bib

---

### Introduction
Lepidopteras play valuable roles in the terrestrial ecosystems of the word. They are an order of insects cosnsisting of 160,000 species of butterflies and moths. They have both forewings and hindwings, each playing roles in functions such as flying and attracting mates. Even when their hindwing is cut off, reducing the surface area of their wing by one half, they are able to keep flying. However, with this loss of wing, the ability for linear flight and acceleration is severely weakened (@jantzen2008hindwings). Hindwings are essential in survival, enabling normal flight function and allowing lepidopterans to evade and defend against predators such as bats and birds. The size variation in the forewings and hindwings has allowed the lepidoptera to obtain high levels of flight and speed as well as directional inconsistnacy, which have evolved to pritotize these functions. The purpose of this study is to determine if the rates of wing-shape evolution between the hindwing and forweing are similar and if they have undergone significant shifts among lineages. Furthermore, we wanted to discover if these hindwing and forewing shapes were correlated with each other. The wings will be evaluated and compared through the phylogenetic analysis of over 200 species of Lepidoptera in a certain taxa. ​​



### Methods

```{r, echo= FALSE, include= FALSE}
library(tidyverse)
library(Momocs)
library(vroom)

f <- list.files("class_out_data",pattern=".txt|.csv",full.names = TRUE)
#all .txt files in "lep_examples" folder
#saves file path to 'f'

out <- read_delim(f[1],delim="\t") %>% 
  as.matrix()
#Use delim = "\t" because fiji uses tab-delimited 
#save first item as a matrix 

out %>% 
  list() %>% 
  Out() %>% 
  coo_flipx()
#transformmatrix into a momocs outline. 
#list() to convert object into a list, since a list of matrices is preferred by the Out() function
#coo_flipx() flips the outline about the x-axis since the origin is in the top left
#stack used to visualize outline

#make a large df with vroom, no longer using a loop since some files are csv, some tab separated (FIJI)
out.df <- vroom::vroom(f, id = "filename")

#make list
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)

outs.l %>% 
  Out() %>% 
  coo_flipx()


#make a large df with vroom
out.df <- vroom::vroom(f, id = "filename") %>% 
  mutate(wing=gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(filename))) %>% 
  na.omit()

#make list
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)

#extract wing info
wings <- gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(names(outs.l)))


outs <-  outs.l %>% 
  Out(fac=list(wing=wings)) %>% 
  coo_flipx()
#pipes the list of matrices into Our() function, flip, and visualize with stack


forewings <- outs %>% 
  filter(wing=="forewing")

hindwings <- outs %>% 
  filter(wing=="hindwing")

#assign outline with forewing to forewings and hindwing to hindwings
#there are now two lists of outlines to analyze

#fixing size:
fore.min <- forewings %>% 
  coo_nb() %>% 
  min()
#coo_nb returns the number of coordinates
#minimize info loss with min()
#assigns fore.min the mininum number of coordinates across forewings

forewings %>%
  coo_interpolate(fore.min) %>% 
  fgProcrustes()
#coo_interpolate extracts number of points at equal intervals
#fgProcrustes minimizes distance between points in each outline to a universal size

#do the same for hindwings
hind.min <- hindwings %>% 
  coo_nb() %>% 
  min()

hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_slide(id=1) %>% 
  coo_align()  %>%
  fgProcrustes()

#EFA
#same code as above, but pipe the transformed outlines to efourier()
#norm=FALSE is used so we align shapes before efourier step, some rotated morpho spaces
forewings %>%
  coo_interpolate(fore.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

forewing.pca <- forewings %>%
  coo_interpolate(fore.min) %>%
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

hindwing.pca <-hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

```

#### PCA Analysis
```{r, echo= FALSE, message= FALSE}
forewing.pca %>% 
  plot_PCA(title = "forewings")

hindwing.pca %>% 
  plot_PCA(title = "hindwings")
```

#### Comparitive Analysis
```{r, echo= FALSE, message= FALSE}
library(ape)

lep.tree <- ape::read.tree("lep_tree2.tre") %>% ladderize()
lep.tree$tip.label <- gsub("_"," ",lep.tree$tip.label)
plot(lep.tree,cex=0.1)


```

```{r, echo= FALSE, include= FALSE}
#connect tree to shapes

#but we do have a file of species names and identifier for their outline names
lep.sp <- read_csv("lep_image_data.csv")
#identifier in this case is the file name without the extention

out.data <- tibble(xy.file=basename(names(outs))) %>% 
  mutate(identifier=gsub("XY_|_hindwing|_forewing|.txt","",xy.file)) %>% 
  left_join(lep.sp)
#make a new tibble without outline names but identifier names using gsub()
#then we merge the species name list to the outlines list using the common identifiers

hindwing.pca2 <-  tibble(xy.file=basename(rownames(hindwing.pca$x)),PC1=hindwing.pca$x[,1],PC2=hindwing.pca$x[,2]) %>% 
  left_join(out.data)
forewing.pca2 <-  tibble(xy.file=basename(rownames(forewing.pca$x)),PC1=forewing.pca$x[,1],PC2=forewing.pca$x[,2])%>% 
  left_join(out.data)
```


### Results

### Discussion

### Contributions

### References



